<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Members</title>
    <script>
      fetch('./navbar.html')
        .then((response) => response.text())
        .then((data) => {
          document.getElementById('navbar-placeholder').innerHTML = data;
        })
        .catch((error) => console.error('Error loading navbar:', error));
    </script>
    <script src="../js/functions.js"></script>
    <link
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
  </head>
  <body>
    <!-- Include the navbar -->
    <div id="navbar-placeholder"></div>

    <div class="container mt-5">
      <div id="member-list" class="list-group">
        <!-- Members will be dynamically inserted here -->
      </div>

      <form id="add-member-form" class="mt-4">
        <div class="form-group">
          <label for="first_name">First Name</label>
          <input type="text" class="form-control" id="first_name" required />
        </div>
        <div class="form-group">
          <label for="last_name">Last Name</label>
          <input type="text" class="form-control" id="last_name" required />
        </div>
        <div class="form-group">
          <label for="username">Username</label>
          <input type="text" class="form-control" id="username" required />
        </div>
        <div class="form-group">
          <label for="password">Password</label>
          <input type="password" class="form-control" id="password" required />
        </div>
        <button type="submit" class="btn btn-primary">Add Member</button>
      </form>

      <form id="update-member-form" class="mt-4" style="display: none;">
        <input type="hidden" id="update-member-id" />
        <div class="form-group">
          <label for="update-first_name">First Name</label>
          <input type="text" class="form-control" id="update-first_name" required />
        </div>
        <div class="form-group">
          <label for="update-last_name">Last Name</label>
          <input type="text" class="form-control" id="update-last_name" required />
        </div>
        <div class="form-group">
          <label for="update-username">Username</label>
          <input type="text" class="form-control" id="update-username" required />
        </div>
        <button type="submit" class="btn btn-primary">Update Member</button>
      </form>
    </div>

    <!-- Modal for viewing member history -->
    <div class="modal fade" id="historyModal" tabindex="-1" aria-labelledby="historyModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="historyModalLabel">Member History</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <ul id="history-list" class="list-group">
              <!-- History items will be dynamically inserted here -->
            </ul>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>

    <script>
      document.addEventListener('DOMContentLoaded', function () {
        fetchMembers().then((data) => {
          const members = data;
          const memberList = document.getElementById('member-list');

          members.forEach((member) => {
            const memberItem = document.createElement('div');
            memberItem.className = 'list-group-item d-flex justify-content-between align-items-center';
            memberItem.id = member.id;

            memberItem.innerHTML = `
              <div>
                <p><strong>First Name:</strong> <span class="member-first-name">${member.first_name}</span></p>
                <p><strong>Last Name:</strong> <span class="member-last-name">${member.last_name}</span></p>
                <p><strong>Username:</strong> <span class="member-username">${member.username}</span></p>
                <p><strong>Status:</strong> <span class="member-status">${member.status}</span></p>
              </div>
              <div>
                ${member.status !== 'DELETED' ? '<button class="btn btn-warning btn-sm edit-btn">Edit</button>' : ''}
                ${member.status !== 'DELETED' ? '<button class="btn btn-danger btn-sm delete-btn">Delete</button>' : ''}
                <button class="btn btn-info btn-sm history-btn">View History</button>
              </div>
            `;

            if (member.status !== 'DELETED') {
              memberItem.querySelector('.delete-btn').addEventListener('click', async function () {
                try {
                  await deleteMember(member.id);
                  memberItem.querySelector('span.member-status').innerText = 'DELETED';
                  memberItem.querySelector('.edit-btn').remove();
                  memberItem.querySelector('.delete-btn').remove();
                  console.log('Member status changed successfully');
                } catch (error) {
                  console.error('Failed to change member status:', error);
                }
              });

              memberItem.querySelector('.edit-btn').addEventListener('click', function () {
                document.getElementById('update-member-id').value = member.id;
                document.getElementById('update-first_name').value = member.first_name;
                document.getElementById('update-last_name').value = member.last_name;
                document.getElementById('update-username').value = member.username;
                document.getElementById('update-member-form').style.display = 'block';
                document.getElementById('add-member-form').style.display = 'none';
              });
            }

            memberItem.querySelector('.history-btn').addEventListener('click', async function () {
              try {
                const history = await fetchMemberHistory(member.id);
                const historyList = document.getElementById('history-list');
                historyList.innerHTML = '';

                history.forEach((entry) => {
                  const historyItem = document.createElement('li');
                  historyItem.className = 'list-group-item';
                  historyItem.innerHTML = `<strong>Action:</strong> ${entry.action} <br> <strong>Date:</strong> ${entry.action_date}`;
                  historyList.appendChild(historyItem);
                });

                $('#historyModal').modal('show');
              } catch (error) {
                console.error('Failed to fetch member history:', error);
              }
            });

            memberList.appendChild(memberItem);
          });
        });

        const addMemberForm = document.getElementById('add-member-form');
        addMemberForm.addEventListener('submit', async function (event) {
          event.preventDefault();

          const first_name = document.getElementById('first_name').value;
          const last_name = document.getElementById('last_name').value;
          const username = document.getElementById('username').value;
          const password = document.getElementById('password').value;

          try {
            const newMember = await addMember(first_name, last_name, username, password);

            const memberItem = document.createElement('div');
            memberItem.className = 'list-group-item d-flex justify-content-between align-items-center';
            memberItem.id = newMember.id;

            memberItem.innerHTML = `
              <div>
                <p><strong>First Name:</strong> <span class="member-first-name">${newMember.first_name}</span></p>
                <p><strong>Last Name:</strong> <span class="member-last-name">${newMember.last_name}</span></p>
                <p><strong>Username:</strong> <span class="member-username">${newMember.username}</span></p>
                <p><strong>Status:</strong> <span class="member-status">${newMember.status}</span></p>
              </div>
              <div>
                <button class="btn btn-warning btn-sm edit-btn">Edit</button>
                <button class="btn btn-danger btn-sm delete-btn">Delete</button>
                <button class="btn btn-info btn-sm history-btn">View History</button>
              </div>
            `;

            memberItem.querySelector('.delete-btn').addEventListener('click', async function () {
              try {
                await deleteMember(newMember.id);
                memberItem.querySelector('span.member-status').innerText = 'DELETED';
                memberItem.querySelector('.edit-btn').remove();
                memberItem.querySelector('.delete-btn').remove();
                console.log('Member status changed successfully');
              } catch (error) {
                console.error('Failed to change member status:', error);
              }
            });

            memberItem.querySelector('.edit-btn').addEventListener('click', function () {
              document.getElementById('update-member-id').value = newMember.id;
              document.getElementById('update-first_name').value = newMember.first_name;
              document.getElementById('update-last_name').value = newMember.last_name;
              document.getElementById('update-username').value = newMember.username;
              document.getElementById('update-member-form').style.display = 'block';
              document.getElementById('add-member-form').style.display = 'none';
            });

            memberItem.querySelector('.history-btn').addEventListener('click', async function () {
              try {
                const history = await fetchMemberHistory(newMember.id);
                const historyList = document.getElementById('history-list');
                historyList.innerHTML = '';

                history.forEach((entry) => {
                  const historyItem = document.createElement('li');
                  historyItem.className = 'list-group-item';
                  historyItem.innerHTML = `<strong>Action:</strong> ${entry.action} <br> <strong>Date:</strong> ${entry.action_date}`;
                  historyList.appendChild(historyItem);
                });

                $('#historyModal').modal('show');
              } catch (error) {
                console.error('Failed to fetch member history:', error);
              }
            });

            memberList.appendChild(memberItem);
            addMemberForm.reset();
          } catch (error) {
            console.error('Failed to add member:', error);
          }
        });

        const updateMemberForm = document.getElementById('update-member-form');
        updateMemberForm.addEventListener('submit', async function (event) {
          event.preventDefault();

          const memberId = document.getElementById('update-member-id').value;
          const first_name = document.getElementById('update-first_name').value;
          const last_name = document.getElementById('update-last_name').value;
          const username = document.getElementById('update-username').value;

          try {
            const updatedMember = await updateMember(memberId, first_name, last_name, username);

            const memberItem = document.getElementById(memberId);
            memberItem.querySelector('span.member-first-name').innerText = `${first_name}`;
            memberItem.querySelector('span.member-last-name').innerText = `${last_name}`;
            memberItem.querySelector('span.member-username').innerText = `${username}`;

            updateMemberForm.reset();
            document.getElementById('update-member-form').style.display = 'none';
            document.getElementById('add-member-form').style.display = 'block';
          } catch (error) {
            console.error('Failed to update member:', error);
          }
        });
      });
    </script>
  </body>
</html>